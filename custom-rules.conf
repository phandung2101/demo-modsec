# ModSecurity Rule Set chống Brute-Force cho endpoint /rest/user/login của Juice Shop

# Định nghĩa số lần thử và thời gian block
SecAction \
  "id:1001000,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:'tx.brute_force_block_timeout=300',\
   setvar:'tx.brute_force_block_counter=5'"

# Xác định request đến endpoint login
SecRule REQUEST_METHOD "^POST$" \
  "id:1001002,\
   phase:1,\
   t:none,\
   nolog,\
   pass,\
   chain"
   SecRule REQUEST_URI "^/rest/user/login$" \
     "t:none,\
      setvar:tx.login_request=1"

# Xử lý đăng nhập thất bại (response code 401)
SecRule RESPONSE_STATUS "^401$" \
  "id:1001003,\
   phase:5,\
   t:none,\
   log,\
   pass,\
   msg:'Failed login',\
   chain"
   SecRule TX:login_request "@eq 1" \
     "t:none,\
      setvar:ip.brute_force_counter=+1,\
      expirevar:ip.brute_force_counter=300,\
      setvar:!tx.login_request"

# Rule đơn giản hóa để test - Chặn request khi vượt quá số lần thử
SecRule IP:brute_force_counter "@gt 3" \
  "id:1001005,\
   phase:1,\
   t:none,\
   deny,\
   status:403,\
   log,\
   msg:'Blocked for too many failed attempts',\
   tag:'attack-brute-force'"