# ModSecurity Rule Set chống Brute-Force cho endpoint /rest/user/login của Juice Shop
# Đặt các rule này trong tệp cấu hình ModSecurity của bạn (REQUEST-1001-BLOCKING-BRUTE-FORCE.conf)

# Cấu hình SecRuleEngine
SecRuleEngine On

# Bật Debug log (nếu cần thiết để gỡ lỗi)
# SecDebugLog /var/log/modsecurity/debug.log
# SecDebugLogLevel 9

# Định nghĩa biến để theo dõi số lần đăng nhập thất bại và thời gian block
SecAction \
  "id:1001000,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:'tx.brute_force_block_timeout=300',\
   setvar:'tx.brute_force_block_counter=5'"

# Khởi tạo biến khi bắt đầu phiên
SecRule REQUEST_HEADERS:Host "." \
  "id:1001001,\
   phase:1,\
   t:none,\
   nolog,\
   pass,\
   ctl:ruleEngine=On,\
   setvar:!tx.login_request"

# Rule xác định request đến endpoint login
SecRule REQUEST_METHOD "^POST$" \
  "id:1001002,\
   phase:1,\
   t:none,\
   nolog,\
   pass,\
   chain"
   SecRule REQUEST_URI "^/rest/user/login$" \
     "t:none,\
      setvar:tx.login_request=1,\
      setvar:tx.login_attack_target=1"

# Rule xử lý đăng nhập thất bại (response code 401)
SecRule RESPONSE_STATUS "^401$" \
  "id:1001003,\
   phase:5,\
   t:none,\
   log,\
   pass,\
   msg:'Potential brute force attempt - Failed login',\
   chain"
   SecRule TX:login_request "@eq 1" \
     "t:none,\
      setvar:ip.brute_force_counter=+1,\
      expirevar:ip.brute_force_counter=%{tx.brute_force_block_timeout},\
      setvar:!tx.login_request,\
      logdata:'Failed login attempt from IP %{REMOTE_ADDR}. Counter: %{ip.brute_force_counter}'
# Rule xử lý đăng nhập thành công (reset counter)
SecRule RESPONSE_STATUS "^2[0-9]{2}$" \
  "id:1001004,\
   phase:5,\
   t:none,\
   nolog,\
   pass,\
   chain"
   SecRule TX:login_request "@eq 1" \
     "t:none,\
      setvar:!tx.login_request,\
      setvar:!ip.brute_force_counter"

# Chặn request nếu vượt quá số lần thử đăng nhập thất bại
SecRule IP:brute_force_counter "@gt %{tx.brute_force_block_counter}" \
  "id:1001005,\
   phase:1,\
   t:none,\
   deny,\
   status:403,\
   log,\
   auditlog,\
   msg:'Brute force attack identified from IP %{REMOTE_ADDR}',\
   logdata:'Failed login attempts: %{ip.brute_force_counter}',\
   tag:'application-multi',\
   tag:'language-multi',\
   tag:'platform-multi',\
   tag:'attack-brute-force',\
   severity:'CRITICAL',\
   chain"
   SecRule TX:login_attack_target "@eq 1" \
     "t:none"

# Ghi log thông tin kiểm tra (debugging)
SecRule IP:brute_force_counter "." \
  "id:1001006,\
   phase:5,\
   t:none,\
   pass,\
   nolog,\
   tag:'DEBUG',\
   logdata:'Current brute force counter for IP %{REMOTE_ADDR}: %{ip.brute_force_counter}'"

# Đảm bảo rule engine được bật cho các rule
SecRuleUpdateTargetById 1001000-1001006 "!REQUEST_HEADERS:Accept"
SecRuleUpdateTargetById 1001000-1001006 "!REQUEST_HEADERS:Host"